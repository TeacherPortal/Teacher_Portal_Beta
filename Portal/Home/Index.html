<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomePage</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=account_circle" />
    <title>HomePage</title>
    <script> 
    function getCookie(name) {
    const cookies = document.cookie.split("; ");
    for (let cookie of cookies) {
        let [key, value] = cookie.split("=");
        if (key === name) return decodeURIComponent(value);
    }
    return null;
}

// Store email in localStorage after login
const email = getCookie("userEmail");
if (email) {
    localStorage.setItem("email", email);
    localStorage.setItem("userEmail",email);
} else {
    console.log("Email not found in cookies");
}
if (!localStorage.getItem("email")) {
    window.location.href = "/";
    }  
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: RGB(255, 228, 196);
        }
/* Popper for the avatar dropdown */
.popperforvatar {
    display: none;
    position: absolute;
    right: 10px;
    top: 50px;
    background: white;
    padding: 10px;
    border: 1px solid #ccc;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.popperforvatar button {
    padding: 10px;
    cursor: pointer;
    background-color: #dc3545;
    color: white;
    border: none;
}

.popperforvatar button:hover {
    background-color: #a71d2a;
}
        .container {
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }
        .quote-box, .calendar-box {
            flex: 1;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .calendar-box {
            margin-left: 20px;

        }
        .calendar-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px;
        }
        .calendar-header button {
            background-color: #b80257;
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            margin: 0 10px;
        }
        .calendar-header button:hover {
            background-color: #900246;
        }
        .calendar-table{
            margin-top: 8px;
            width: 100%;
        }
        
        .calendar-table th,
        .calendar-table td {
            border: 1px solid #000;
            padding: 17px;
            text-align: center;margin: 5px;
        }
        .calendar-table td.booked {
            background-color: #b80257;
            color: white;
        }
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: RGB(255, 228, 196);
            border: 1px solid #ddd;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            z-index: 1000;
            width: 300px;
            border-radius: 10px;
        }
        
        #popup-close, #popup-book {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
            margin-top: 10px;
        }
        
        #popup-book {
            background-color: #007BFF;
        }
        
        #popup-book:hover {
            background-color: #0056b3;
        }
        
        #popup-close:hover {
            background-color: #a71d2a;
        }
        
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .logo img {
            height: 40px;
        }
        nav .logo img:hover {
        transform: scale(1.1);
    }
    nav .logo img {
            transition: transform 0.3s ease-in-out;
        }
    nav{
        background-color: #900246;
        box-shadow: 3px 3px 5px rgba(0,0,0,0.1);
        margin: 0;
        padding: 0;
    }
    nav ul {
    width: 100%;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0;
    margin: 0;
}
.welcome-message {
    flex-grow: 1;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
}


    nav li{
        height: 50px;
    }
    nav a{
        height: 100%;
        padding: 0 30px;
        text-decoration: none;
        display: flex;
        align-items: center;
        color: white;
    }
    .dropdown a:hover{
        background-color: #f0f0f0;
        color: black;
    }
    nav li:first-child{
        margin-right: auto;
    }
    /* Dropdown Menu */
.dropdown {
    position: relative;
}

.dropdown ul {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background-color: white;
    list-style: none;
    padding: 0;
    margin: 0;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    min-width: 140px;
    border-radius: 9px;
    margin-top: 2px;
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    opacity: 0;
    visibility: hidden;
}

.dropdown ul li {
    width: 100%;
    border-bottom: 1px inset #ccc;
    border-radius: 5px;
}
.dropdown ul li a {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3px;
    text-decoration: none;
    color: #900246;
    transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
}

.dropdown ul li a:hover {
    background-color: #900246;
    color: white;
    opacity: 1;
    visibility: visible;
    display: flex;
}
.dropdown:hover ul {
    display: block;
    opacity: 1;
    visibility: visible;
}

    </style>
</head>
<body>
    <nav>
        <ul>
            <li class="logo">
                <a href="/homepage"> 
                    <div data-image-name="mainlogo">
                        <img src="" alt="Logo" id="mainlogo">
                    </div>
                </a>
            </li>
            <li class="welcome-message"><a href="#">Hi, <span id="welcome-message">, Guest!</span></a></li>
            <li class="dropdown"><a href="#" class="dropbtn">Classroom</a>
                <ul>
                    <li><a href="/bookclass">Book Class</a></li>
                    <li><a href="/displayclass">Check Availability</a></li>
                </ul>
            </li>
            <li class="dropdown"><a href="#" class="dropbtn">Hall</a>
                <ul>
                    <li><a href="/booking">Book Hall</a></li>
                    <li><a href="/forall">Check Availability</a></li>
                </ul>
            </li>
            <li class="account">
                <a href="#">
                    <div class="vatar">
                        <span class="material-symbols-outlined">account_circle</span>
                    </div>
                </a>
                <div class="popperforvatar" style="display: none; position: absolute; right: 0; top: 50px; background: white; padding: 10px; border: 1px solid #ccc; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
                    <button id="logout-btn">Logout</button>
                </div>
            </li>
        </ul>
    </nav>   
    <div class="container">
        <div class="quote-box">
            <h2>Message Of The Day</h2>
            <h3 style="color: #b80257;">Om Amriteswaryai Namah</h3>
            <p class="quote" id="quote" style="color: #900246;padding-bottom: 15px;"></p>
            <p style="color: #900246;">Chancellor,</p>
            <p class="author" id="author" style="color: #900246;"></p>
        </div>
        <div class="calendar-box">
            <h2 style="text-align: center;">Calendar</h2>
            <div class="calendar">
                <div class="calendar-header">
                    <button id="prevMonth">&lt;</button>
                    <h3 id="currentMonth">January 2024</h3>
                    <button id="nextMonth">&gt;</button>
                </div>
                <table class="calendar-table">
                    <thead>
                        <tr>
                            <th>Sun</th>
                            <th>Mon</th>
                            <th>Tue</th>
                            <th>Wed</th>
                            <th>Thu</th>
                            <th>Fri</th>
                            <th>Sat</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="overlay"></div>
    <div id="popup">
        <h3 id="popup-title">Booking Details</h3>
        <p id="popup-content"></p>
        <button id="popup-book">Book</button>
        <button id="popup-close">Close</button>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
    let dropdown = document.querySelector(".dropdown");
    let dropdownMenu = dropdown.querySelector("ul");
    let timeout;

    dropdown.addEventListener("mouseenter", function() {
        clearTimeout(timeout);
        dropdownMenu.style.display = "block";
    });

    dropdown.addEventListener("mouseleave", function() {
        timeout = setTimeout(() => {
            dropdownMenu.style.display = "none";
        }, 200); // Adjust delay time if needed
    });

    dropdownMenu.addEventListener("mouseenter", function() {
        clearTimeout(timeout);
    });

    dropdownMenu.addEventListener("mouseleave", function() {
        timeout = setTimeout(() => {
            dropdownMenu.style.display = "none";
        }, 200);
    });
});
        // Toggle visibility of .popperforvatar on .vatar click
const vatar = document.querySelector('.vatar');
const popper = document.querySelector('.popperforvatar');

vatar.addEventListener('click', () => {
    const isVisible = popper.style.display === 'block';
    popper.style.display = isVisible ? 'none' : 'block';
});

// Logout functionality
const logoutBtn = document.getElementById('logout-btn');
logoutBtn.addEventListener('click', () => {
    // Clear cookies
    document.cookie = 'userName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    document.cookie = 'userEmail=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    localStorage.removeItem('email');
    localStorage.removeItem('userEmail');
    history.replaceState(null, null, "/");
    // Redirect to LoginPage
    window.location.href = '/';
});
document.addEventListener("DOMContentLoaded", function () {
    fetch('/api/quote') // Make sure this matches your backend route
        .then(response => {
            console.log("Response received:", response);
            return response.json();
        })
        .then(data => {
            console.log("Quote Data:", data);
            document.getElementById("quote").innerText = data.content;
            document.getElementById("author").innerText = data.author;
        })
        .catch(error => {
            console.error("Error fetching quote:", error);
            document.getElementById("quote").innerText = "Failed to load quote.";
        });
});
// Prevent back navigation to protected pages
window.addEventListener('popstate', () => {
    const userName = document.cookie.split('; ').find(row => row.startsWith('userName='));
    if (!userName) {
        window.location.href = 'views/LoginPage.html';
    }
});
document.addEventListener('DOMContentLoaded', () => {
    const userName = document.cookie.split('; ').find(row => row.startsWith('userName='));
    const userEmail = document.cookie.split('; ').find(row => row.startsWith('userEmail='));

    if (!userName || !userEmail) {
        // Redirect to login page if cookies are missing
        window.location.href = '/views/LoginPage.html';
    }
});
        
        
        
        async function fetchImageByName(imageName) {
        try {
            const response = await fetch(`/api/image?name=${imageName}`);
            if (!response.ok) throw new Error(`Image not found: ${imageName}`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById(imageName).src = url;
        } catch (error) {
            console.error('Error fetching image:', error);
        }
    }

    // Fetch all images based on their data attributes
    document.querySelectorAll('[data-image-name]').forEach(element => {
        const imageName = element.getAttribute('data-image-name');
        fetchImageByName(imageName);
    });
        let bookings = [];
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('overlay');
        const popupContent = document.getElementById('popup-content');
        const welcomeMessage = document.getElementById('welcome-message');
    
        async function fetchUserBookings() {
            try {
                // Retrieve user name from cookies
                const userName = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('userName='))
                    ?.split('=')[1];
    
                if (!userName) {
                    alert('User not logged in!');
                    window.location.href = '/';
                    return;
                }
    
                welcomeMessage.textContent = ` ${userName}!`;
                welcomeMessage.textContent = `Welcome, ${userName}!`;
    
                // Fetch user email and bookings from the server
                const response = await fetch(`/api/bookings?userName=${userName}`);
                const data = await response.json();
    
                if (data.error) {
                    console.error('Error fetching bookings:', data.error);
                    alert('Error fetching bookings.');
                    return;
                }
    
                bookings = data.bookings; // User-specific bookings
            } catch (error) {
                console.error('Failed to fetch bookings', error);
            }
        }
    
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            document.getElementById('currentMonth').textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });
    
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
    
            let row = document.createElement('tr');
            for (let i = 0; i < firstDay; i++) row.appendChild(document.createElement('td'));
    
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('td');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
                const dateBookings = bookings.filter(b => b.date === dateStr);
    
                cell.textContent = day;
    
                if (dateBookings.length > 0) {
                    cell.classList.add('booked');
                    cell.addEventListener('click', () => {
                        popupContent.innerHTML = '';
                        dateBookings.forEach(booking => {
                            popupContent.innerHTML += `
                                <p><strong>Venue:</strong> ${booking.venue}</p>
                                <p><strong>Date:</strong> ${booking.date}</p>
                                <p><strong>Start Time:</strong> ${booking.startTime}</p>
                                <p><strong>End Time:</strong> ${booking.endTime}</p>
                                <p><strong>Message:</strong> ${booking.message}</p>
                                <hr>
                            `;
                        });
    
                        popup.style.display = 'block';
                        overlay.style.display = 'block';
                    });
                }
    
                row.appendChild(cell);
    
                if ((firstDay + day) % 7 === 0) {
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                }
            }
    
            if (row.childNodes.length > 0) calendarBody.appendChild(row);
        }
    
        document.getElementById('popup-close').addEventListener('click', () => {
            popup.style.display = 'none';
            overlay.style.display = 'none';
        });
        document.getElementById('popup-book').addEventListener('click', () => {
            window.location.href = '/booking';
        });
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
    
        const currentDate = new Date();
        window.onload = async () => {
            await fetchUserBookings(); // Fetch user-specific bookings
            renderCalendar(currentDate);
        };
    </script>    
</body>
</html>
