<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=account_circle" />
    <title>Class Form</title>
    <script>
        if (!localStorage.getItem("email")) {
        window.location.href = "/";
        }  
      </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: RGB(255,228,196);
            margin: 0;
            padding: 0;
        }
        nav .logo img {
            height: 40px;
            transition: transform 0.3s ease-in-out;
        }
        img{
            overflow-clip-margin: content-box;
            overflow: clip;
        }
        nav .logo img:hover {
        transform: scale(1.1);
        }
        .container {
            width: 40%;
            margin: 40px auto;
            background-color: #b80257;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            margin-left: 25%;
        }
        
        .container input, select, textarea{
            width: 50%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 1rem;
            margin-left: 25%;
        }
        .container span{
            display: block;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .container button {
            width: 50%;
            margin-left: 25%;
            padding: 12px;
            background-color: #dd356e;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        button:hover {
            background: #218838;
        }
        
        #loader {
            display: block;
            text-align: center;
            margin-top: 10px;
            color: #333;
        }
        nav {
            background-color: #b80257;
            padding: 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav ul {
            display: flex;
            justify-content: flex-end;
            width: 100%;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        nav ul li {
            margin-left: 20px;
            margin-top: 20px;
        }
        nav ul li.logo {
            margin-right: auto;
            margin-top: 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            padding-right: 15px;
        }
        nav ul li .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }
        nav ul li .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        nav ul li .dropdown-content a:hover {
            background-color: #ddd;
        }
        nav ul li:hover .dropdown-content {
            display: block;
        }
        .vatar{
            margin-left: 40px;
            margin-right: 10px;
        }
        .popperforvatar button {
    padding: 10px;
    cursor: pointer;
    background-color: #dc3545;
    color: white;
    border: none;
    }   
    h1 {
            color: #b80257;
            text-align: center;
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li class="logo">
                <a href="/homepage"> 
                    <div data-image-name="mainlogo">
                        <img src="" alt="Logo" id="mainlogo">
                    </div>
                </a>
            </li>
            <li class="dropdown">
                <a href="#" class="dropbtn">Classroom</a>
                <div class="dropdown-content">
                    <a href="#">Book Class</a>
                    <a href="#">Check Availability</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="#" class="dropbtn">Hall</a>
                <div class="dropdown-content">
                    <a href="/booking">Book Hall</a>
                    <a href="/forall">Check Availability</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="/homepage">Home</a>
            </li>
            <li class="account">
                <a href="#">
                    <div class="vatar">
                        <span class="material-symbols-outlined">account_circle</span>
                    </div>
                </a>
                <div class="popperforvatar" style="display: none; position: absolute; right: 0; top: 50px; background: white; padding: 10px; border: 1px solid #ccc; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
                    <button id="logout-btn">Logout</button>
                </div>
            </li>
        </ul>
    </nav> 
    <h1>Create Class</h1>      
    <div class="container">
        <form id="classForm">
            <label>Course Name:</label>
            <input type="text" name="courseName" required>

            <label>Course Code:</label>
            <input type="text" name="courseCode" required>

            <label>Instructor:</label>
            <input type="text" name="instructor" required>

            <label>Location:</label>
            <select name="location" id="locationSelect">
                <option value="">Loading...</option>
            </select>

            <label>Day:</label>
            <select name="day" id="daySelect">
                <option value="">Select a Day</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
            </select>

            <label>Slot:</label>
            <select name="slot" id="slotSelect">
                <option value="">Please select a slot</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select>

            <label>Time:</label>
            <span id="timeDisplay">8:00 AM - 8:50 AM</span>
            <label>Description:</label>
            <textarea name="description"></textarea>

            <button type="submit" id="submitBtn">Submit</button>
            <span id="loader" style="display: none;">Loading...</span>
        </form>
    </div>
    <script>
            document.querySelector('.vatar').addEventListener('click', function () {
            const popper = document.querySelector('.popperforvatar');
            if (popper.style.display === 'none' || !popper.style.display) {
                popper.style.display = 'block'; // Show the dropdown
            } else {
                popper.style.display = 'none'; // Hide the dropdown
         }
        });
        document.addEventListener('click', function (event) {
        const popper = document.querySelector('.popperforvatar');
        const vatar = document.querySelector('.vatar');
        if (popper && !vatar.contains(event.target) && !popper.contains(event.target)) {
        popper.style.display = 'none';
        }
        });
        const logoutBtn = document.getElementById('logout-btn');
logoutBtn.addEventListener('click', () => {
    // Clear cookies
    document.cookie = 'userName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    document.cookie = 'userEmail=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    localStorage.removeItem('email');
    localStorage.removeItem('userEmail');
    history.replaceState(null, null, "/");
    // Redirect to LoginPage
    window.location.href = '/';
});
    async function fetchImageByName(imageName) {
        try {
            const response = await fetch(`/api/image?name=${imageName}`);
            if (!response.ok) throw new Error(`Image not found: ${imageName}`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById(imageName).src = url;
        } catch (error) {
            console.error('Error fetching image:', error);
        }
    }

    // Fetch all images based on their data attributes
    document.querySelectorAll('[data-image-name]').forEach(element => {
        const imageName = element.getAttribute('data-image-name');
        fetchImageByName(imageName);
    });
    const slotTimes = {
            "1": "8:00 AM - 8:50 AM",
            "2": "8:50 AM - 9:40 AM",
            "3": "9:40 AM - 10:30 AM",
            "4": "10:45 AM - 11:35 AM",
            "5": "11:35 PM - 12:25 PM",
            "6": "12:25 PM - 1:15 PM",
            "7": "1:15 PM - 2:05 PM",
            "8": "2:05 PM - 2:55 PM",
            "9": "2:55 PM - 3:45 PM",
            "10": "3:45 PM - 4:35 PM",
            "11": "4:35 PM - 5:25 PM",
            "12": "5:25 PM - 6:15 PM"
        };

        // Get elements
        const daySelect = document.getElementById("daySelect");
        const slotSelect = document.getElementById("slotSelect");
        const locationSelect = document.getElementById("locationSelect");
        const timeDisplay = document.getElementById("timeDisplay");
        const submitBtn = document.getElementById("submitBtn");
        const loader = document.getElementById("loader");

        // Fetch and populate locations
        async function fetchLocations() {
            try {
                const response = await fetch("http://localhost:3000/get-locations");
                const data = await response.json();

                locationSelect.innerHTML = ""; // Clear existing options

                data.locations.forEach(location => {
                    const option = document.createElement("option");
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching locations:", error);
                alert("Failed to load locations.");
            }
        }

        // Update time display when slot is changed
        slotSelect.addEventListener("change", function () {
            timeDisplay.textContent = slotTimes[this.value] || "Select a valid slot";
        });

        // Function to fetch occupied slots dynamically based on day & location
        async function fetchOccupiedSlots() {
            const selectedDay = daySelect.value;
            const selectedLocation = locationSelect.value;

            if (!selectedDay || !selectedLocation) return;

            try {
                const response = await fetch(`http://localhost:3000/get-permanent-slots?day=${selectedDay}&location=${selectedLocation}`);
                const occupiedSlots = await response.json();

                // Enable all slots first
                [...slotSelect.options].forEach(option => {
                    option.hidden = false;
                    option.disabled = false;
                });

                // Disable already booked slots for the selected location
                occupiedSlots.forEach(slot => {
                    const option = slotSelect.querySelector(`option[value="${slot}"]`);
                    if (option) {
                        option.hidden = true;
                        option.disabled = true;
                    }
                });
            } catch (error) {
                console.error("Error fetching occupied slots:", error);
                alert("Error fetching occupied slots. Please try again.");
            }
        }

        // Update slot availability when either day OR location changes
        daySelect.addEventListener("change", fetchOccupiedSlots);
        locationSelect.addEventListener("change", fetchOccupiedSlots);

        // Handle form submission
        document.getElementById("classForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            // Disable submit button and show loader
            submitBtn.disabled = true;
            loader.style.display = "inline";

            const formData = new FormData(event.target);
            const selectedSlot = formData.get("slot");
            const selectedDay = formData.get("day");

            // Validate slot selection
            if (!selectedDay) {
                alert("Please select a day!");
                submitBtn.disabled = false;
                loader.style.display = "none";
                return;
            }

            if (!selectedSlot) {
                alert("Please select a valid slot!");
                submitBtn.disabled = false;
                loader.style.display = "none";
                return;
            }

            const data = {
                courseName: formData.get("courseName"),
                courseCode: formData.get("courseCode"),
                instructor: formData.get("instructor"),
                location: formData.get("location"),
                day: selectedDay,
                slots: [{
                    slot: selectedSlot,
                    time: slotTimes[selectedSlot],
                    status: "permanent",
                }],
                description: formData.get("description"),
            };

            try {
                const response = await fetch("http://localhost:3000/add-class", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);

                    // Reset form fields
                    event.target.reset();
                    slotSelect.value = ""; // Reset slot dropdown
                    timeDisplay.textContent = "Select a valid slot"; // Reset time display
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                alert("An error occurred. Please try again.");
            } finally {
                // Re-enable submit button and hide loader
                submitBtn.disabled = false;
                loader.style.display = "none";
            }
        });

        // Load locations when page loads
        fetchLocations();
    </script>

</body>

</html>