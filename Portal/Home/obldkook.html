<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Booker Ease</title>
</head>

<body>
    <h2>Book a Class</h2>
    <form id="classForm">
        <label>Course Name:</label>
        <input type="text" name="courseName" required><br>

        <label>Course Code:</label>
        <input type="text" name="courseCode" required><br>

        <label>Instructor:</label>
        <input type="text" name="instructor" required><br>

        <label>Location:</label>
        <select name="location" id="locationSelect" required>
            <option value="">Loading locations...</option>
        </select><br>

        <label>Date:</label>
        <input type="date" id="datePicker" name="date" required><br>

        <label>Slot:</label>
        <select name="slot" id="slotSelect">
            <option value="">Please select a slot</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
        </select><br>

        <label>Time:</label>
        <span id="timeDisplay">Select a slot</span><br>

        <label>Description:</label>
        <textarea name="description"></textarea><br>

        <button type="submit" id="submitBtn">Submit</button>
        <span id="loader" style="display: none;">Loading...</span>
    </form>

    <script>
        const slotTimes = {
            "1": "8:00 AM - 8:50 AM",
            "2": "8:50 AM - 9:40 AM",
            "3": "9:40 AM - 10:30 AM",
            "4": "10:45 AM - 11:35 AM",
            "5": "11:35 PM - 12:25 PM",
            "6": "12:25 PM - 1:15 PM",
            "7": "1:15 PM - 2:05 PM",
            "8": "2:05 PM - 2:55 PM",
            "9": "2:55 PM - 3:45 PM",
            "10": "3:45 PM - 4:35 PM",
            "11": "4:35 PM - 5:25 PM",
            "12": "5:25 PM - 6:15 PM"
        };

        // DOM Elements
        const datePicker = document.getElementById("datePicker");
        const slotSelect = document.getElementById("slotSelect");
        const locationSelect = document.getElementById("locationSelect");
        const timeDisplay = document.getElementById("timeDisplay");
        const submitBtn = document.getElementById("submitBtn");
        const loader = document.getElementById("loader");

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        datePicker.setAttribute("min", today);

        // Fetch locations dynamically
        async function fetchLocations() {
            try {
                const response = await fetch("http://localhost:3000/get-locations");
                const data = await response.json();

                locationSelect.innerHTML = ""; // Clear existing options

                data.locations.forEach(location => {
                    const option = document.createElement("option");
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            } catch (error) {
                console.error("ðŸ”¥ Error fetching locations:", error);
                alert("Failed to load locations.");
            }
        }

        // Event Listener for Slot Selection
        slotSelect.addEventListener("change", function () {
            timeDisplay.textContent = slotTimes[this.value] || "Select a valid slot";
        });

        // Function to Get Day from Date
        function getDayFromDate(dateString) {
            const date = new Date(dateString);
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            return days[date.getDay()];
        }

        // Fetch Occupied Slots (Permanent + Booked)
        async function fetchOccupiedSlots() {
            const selectedDate = datePicker.value;
            const selectedLocation = locationSelect.value;

            if (!selectedDate || !selectedLocation) return;

            const selectedDay = getDayFromDate(selectedDate);

            try {
                const permResponse = await fetch(`http://localhost:3000/get-permanent-slots?day=${selectedDay}&location=${selectedLocation}`);
                const permOccupiedSlots = await permResponse.json();

                const bookedResponse = await fetch(`http://localhost:3000/get-booked-slots?date=${selectedDate}&location=${selectedLocation}`);
                const bookedSlots = await bookedResponse.json();

                const allOccupiedSlots = new Set([...permOccupiedSlots, ...bookedSlots]);

                // Reset all slot options
                [...slotSelect.options].forEach(option => {
                    option.hidden = false;
                    option.disabled = false;
                });

                // Disable booked slots
                allOccupiedSlots.forEach(slot => {
                    const option = slotSelect.querySelector(`option[value="${slot}"]`);
                    if (option) {
                        option.hidden = true;
                        option.disabled = true;
                    }
                });

            } catch (error) {
                console.error("ðŸ”¥ Error fetching occupied slots:", error);
                alert("Error fetching occupied slots. Please try again.");
            }
        }

        // Fetch occupied slots when date or location changes
        datePicker.addEventListener("change", fetchOccupiedSlots);
        locationSelect.addEventListener("change", fetchOccupiedSlots);

        // Handle Form Submission
        document.getElementById("classForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            submitBtn.disabled = true;
            loader.style.display = "inline";

            const formData = new FormData(event.target);
            const selectedSlot = formData.get("slot");
            const selectedDate = formData.get("date");

            if (!selectedDate) {
                alert("Please select a date!");
                resetSubmitButton();
                return;
            }

            if (!selectedSlot) {
                alert("Please select a valid slot!");
                resetSubmitButton();
                return;
            }

            const selectedDay = getDayFromDate(selectedDate);

            const data = {
                courseName: formData.get("courseName"),
                courseCode: formData.get("courseCode"),
                instructor: formData.get("instructor"),
                location: formData.get("location"),
                date: selectedDate,
                day: selectedDay,
                slots: [{
                    slot: selectedSlot,
                    time: slotTimes[selectedSlot],
                    status: "temporary"
                }],
                description: formData.get("description")
            };

            try {
                const response = await fetch("http://localhost:3000/add-classbookerease", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                    slotSelect.value = "";
                    timeDisplay.textContent = "Select a slot";
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error("ðŸ”¥ Error submitting form:", error);
                alert("An error occurred. Please try again.");
            } finally {
                resetSubmitButton();
            }
        });

        function resetSubmitButton() {
            submitBtn.disabled = false;
            loader.style.display = "none";
        }

        // Load locations when page loads
        fetchLocations();
    </script>
</body>

</html>