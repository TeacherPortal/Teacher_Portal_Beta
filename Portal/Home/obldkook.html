<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=account_circle" />
    <title>Class Booker Ease</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: RGB(255,228,196);
            margin: 0;
            padding: 0;
        }
        nav .logo img {
            height: 40px;
            transition: transform 0.3s ease-in-out;
        }
        img{
            overflow-clip-margin: content-box;
            overflow: clip;
        }
        nav .logo img:hover {
        transform: scale(1.1);
        }
        .container {
            width: 40%;
            margin: 40px auto;
            background-color: #b80257;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }

        .container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            margin-left: 25%;
        }

        .container input, select, textarea {
            width: 50%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 1rem;
            margin-left: 25%;
        }

        .container textarea {
            height: 80px;
            resize: none;
        }

        .container button {
            width: 50%;
            margin-left: 25%;
            padding: 12px;
            background-color: #dd356e;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .container button:hover {
            background-color: lightpink;
        }

        #loader {
            display: none;
            text-align: center;
            font-size: 14px;
            color: #555;
        }

        #timeDisplay {
            display: block;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }
        nav{
        background-color: #900246;
        box-shadow: 3px 3px 5px rgba(0,0,0,0.1);
        margin: 0;
        padding: 0;
    }
    nav ul {
    width: 100%;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0;
    margin: 0;
}

    nav li{
        height: 50px;
    }
    nav a{
        height: 100%;
        padding: 0 20px;
        text-decoration: none;
        display: flex;
        align-items: center;
        color: white;
    }
    .dropdown a:hover{
        background-color: #f0f0f0;
        color: black;
    }
    nav li:first-child{
        margin-right: auto;
    }
    /* Dropdown Menu */
.dropdown {
    position: relative;
}

.dropdown ul {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background-color: white;
    list-style: none;
    padding: 0;
    margin: 0;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    min-width: 140px;
    border-radius: 9px;
    margin-top: 2px;
    transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
    opacity: 0;
    visibility: hidden;
}

.dropdown ul li {
    width: 100%;
    border-bottom: 1px inset #ccc;
    border-radius: 5px;
}

.dropdown ul li a {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3px;
    text-decoration: none;
    color: #900246;
    transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
}

.dropdown ul li a:hover {
    background-color: #900246;
    color: white;
    opacity: 1;
    visibility: visible;
    display: flex;
}
.dropdown:hover ul {
    display: block;
    opacity: 1;
    visibility: visible;
}
        .vatar{
            margin-left: 10px;
            margin-right: 10px;
        }
        .popperforvatar button {
        padding: 10px;
        cursor: pointer;
        background-color: #dc3545;
        color: white;
        border: none;
        }   
        h1 {
            color: #b80257;
            text-align: center;
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li class="logo">
                <a href="/homepage"> 
                    <div data-image-name="mainlogo">
                        <img src="" alt="Logo" id="mainlogo">
                    </div>
                </a>
            </li>
            <li class="dropdown"><a href="#" class="dropbtn">Classroom</a>
                <ul>
                    <li><a href="/bookclass">Book Class</a></li>
                    <li><a href="/displayclass">Check Availability</a></li>
                </ul>
            </li>
            <li class="dropdown"><a href="#" class="dropbtn">Hall</a>
                <ul>
                    <li><a href="/booking">Book Hall</a></li>
                    <li><a href="/forall">Check Availability</a></li>
                </ul>
            </li>
            <li><a href="/homepage">Home</a></li>
            <li class="account">
                <a href="#">
                    <div class="vatar">
                        <span class="material-symbols-outlined">account_circle</span>
                    </div>
                </a>
                <div class="popperforvatar" style="display: none; position: absolute; right: 0; top: 50px; background: white; padding: 10px; border: 1px solid #ccc; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);">
                    <button id="logout-btn">Logout</button>
                </div>
            </li>
        </ul>
    </nav>
    <h1>Book Class</h1>   
    <div class="container">
        <form id="classForm">
            <label>Course Name:</label>
            <input type="text" name="courseName" required>

            <label>Course Code:</label>
            <input type="text" name="courseCode" required>

            <label>Instructor:</label>
            <input type="text" name="instructor" required>

            <label>Location:</label>
            <select name="location" id="locationSelect" required>
                <option value="">Loading locations...</option>
            </select>

            <label>Date:</label>
            <input type="date" id="datePicker" name="date" required>

            <label>Slot:</label>
            <select name="slot" id="slotSelect">
                <option value="">Please select a slot</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select>

            <label>Time:</label>
            <span id="timeDisplay">Select a slot</span>

            <label>Description:</label>
            <textarea name="description"></textarea>

            <button type="submit" id="submitBtn">Submit</button>
            <span id="loader">Loading...</span>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
    let dropdown = document.querySelector(".dropdown");
    let dropdownMenu = dropdown.querySelector("ul");
    let timeout;

    dropdown.addEventListener("mouseenter", function() {
        clearTimeout(timeout);
        dropdownMenu.style.display = "block";
    });

    dropdown.addEventListener("mouseleave", function() {
        timeout = setTimeout(() => {
            dropdownMenu.style.display = "none";
        }, 200); // Adjust delay time if needed
    });

    dropdownMenu.addEventListener("mouseenter", function() {
        clearTimeout(timeout);
    });

    dropdownMenu.addEventListener("mouseleave", function() {
        timeout = setTimeout(() => {
            dropdownMenu.style.display = "none";
        }, 200);
    });
});

        document.querySelector('.vatar').addEventListener('click', function () {
            const popper = document.querySelector('.popperforvatar');
            if (popper.style.display === 'none' || !popper.style.display) {
                popper.style.display = 'block'; // Show the dropdown
            } else {
                popper.style.display = 'none'; // Hide the dropdown
         }
        });
        document.addEventListener('click', function (event) {
        const popper = document.querySelector('.popperforvatar');
        const vatar = document.querySelector('.vatar');
        if (popper && !vatar.contains(event.target) && !popper.contains(event.target)) {
        popper.style.display = 'none';
        }
        });
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
    // Clear cookies
        document.cookie = 'userName=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        document.cookie = 'userEmail=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    
    // Redirect to LoginPage
        window.location.href = '/';
    });
    async function fetchImageByName(imageName) {
        try {
            const response = await fetch(`/api/image?name=${imageName}`);
            if (!response.ok) throw new Error(`Image not found: ${imageName}`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById(imageName).src = url;
        } catch (error) {
            console.error('Error fetching image:', error);
        }
    }

    // Fetch all images based on their data attributes
    document.querySelectorAll('[data-image-name]').forEach(element => {
        const imageName = element.getAttribute('data-image-name');
        fetchImageByName(imageName);
    });
    const slotTimes = {
            "1": "8:00 AM - 8:50 AM",
            "2": "8:50 AM - 9:40 AM",
            "3": "9:40 AM - 10:30 AM",
            "4": "10:45 AM - 11:35 AM",
            "5": "11:35 PM - 12:25 PM",
            "6": "12:25 PM - 1:15 PM",
            "7": "1:15 PM - 2:05 PM",
            "8": "2:05 PM - 2:55 PM",
            "9": "2:55 PM - 3:45 PM",
            "10": "3:45 PM - 4:35 PM",
            "11": "4:35 PM - 5:25 PM",
            "12": "5:25 PM - 6:15 PM"
        };

        // DOM Elements
        const datePicker = document.getElementById("datePicker");
        const slotSelect = document.getElementById("slotSelect");
        const locationSelect = document.getElementById("locationSelect");
        const timeDisplay = document.getElementById("timeDisplay");
        const submitBtn = document.getElementById("submitBtn");
        const loader = document.getElementById("loader");

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        datePicker.setAttribute("min", today);

        // Fetch locations dynamically
        async function fetchLocations() {
            try {
                const response = await fetch("http://localhost:3000/get-locations");
                const data = await response.json();

                locationSelect.innerHTML = ""; // Clear existing options

                data.locations.forEach(location => {
                    const option = document.createElement("option");
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            } catch (error) {
                console.error("🔥 Error fetching locations:", error);
                alert("Failed to load locations.");
            }
        }

        // Event Listener for Slot Selection
        slotSelect.addEventListener("change", function () {
            timeDisplay.textContent = slotTimes[this.value] || "Select a valid slot";
        });

        // Function to Get Day from Date
        function getDayFromDate(dateString) {
            const date = new Date(dateString);
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            return days[date.getDay()];
        }

        // Fetch Occupied Slots (Permanent + Booked)
        async function fetchOccupiedSlots() {
            const selectedDate = datePicker.value;
            const selectedLocation = locationSelect.value;

            if (!selectedDate || !selectedLocation) return;

            const selectedDay = getDayFromDate(selectedDate);

            try {
                const permResponse = await fetch(`http://localhost:3000/get-permanent-slots?day=${selectedDay}&location=${selectedLocation}`);
                const permOccupiedSlots = await permResponse.json();

                const bookedResponse = await fetch(`http://localhost:3000/get-booked-slots?date=${selectedDate}&location=${selectedLocation}`);
                const bookedSlots = await bookedResponse.json();

                const allOccupiedSlots = new Set([...permOccupiedSlots, ...bookedSlots]);

                // Reset all slot options
                [...slotSelect.options].forEach(option => {
                    option.hidden = false;
                    option.disabled = false;
                });

                // Disable booked slots
                allOccupiedSlots.forEach(slot => {
                    const option = slotSelect.querySelector(`option[value="${slot}"]`);
                    if (option) {
                        option.hidden = true;
                        option.disabled = true;
                    }
                });

            } catch (error) {
                console.error("🔥 Error fetching occupied slots:", error);
                alert("Error fetching occupied slots. Please try again.");
            }
        }

        // Fetch occupied slots when date or location changes
        datePicker.addEventListener("change", fetchOccupiedSlots);
        locationSelect.addEventListener("change", fetchOccupiedSlots);

        // Handle Form Submission
        document.getElementById("classForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            submitBtn.disabled = true;
            loader.style.display = "inline";

            const formData = new FormData(event.target);
            const selectedSlot = formData.get("slot");
            const selectedDate = formData.get("date");

            if (!selectedDate) {
                alert("Please select a date!");
                resetSubmitButton();
                return;
            }

            if (!selectedSlot) {
                alert("Please select a valid slot!");
                resetSubmitButton();
                return;
            }

            const selectedDay = getDayFromDate(selectedDate);

            const data = {
                courseName: formData.get("courseName"),
                courseCode: formData.get("courseCode"),
                instructor: formData.get("instructor"),
                location: formData.get("location"),
                date: selectedDate,
                day: selectedDay,
                slots: [{
                    slot: selectedSlot,
                    time: slotTimes[selectedSlot],
                    status: "temporary"
                }],
                description: formData.get("description")
            };

            try {
                const response = await fetch("http://localhost:3000/add-classbookerease", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                    slotSelect.value = "";
                    timeDisplay.textContent = "Select a slot";
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error("🔥 Error submitting form:", error);
                alert("An error occurred. Please try again.");
            } finally {
                resetSubmitButton();
            }
        });

        function resetSubmitButton() {
            submitBtn.disabled = false;
            loader.style.display = "none";
        }

        // Load locations when page loads
        fetchLocations();
    </script>

</body>
</html>
